\pdfminorversion=4
\documentclass[aspectratio=169]{beamer}

\mode<presentation>
{
  \usetheme{default}
  \usecolortheme{default}
  \usefonttheme{default}
  \setbeamertemplate{navigation symbols}{}
  \setbeamertemplate{caption}[numbered]
  \setbeamertemplate{footline}[frame number]  % or "page number"
  \setbeamercolor{frametitle}{fg=white}
  \setbeamercolor{footline}{fg=black}
} 

\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{tikz}
\usepackage{courier}
\usepackage{array}
\usepackage{bold-extra}
\usepackage{minted}
\usepackage[thicklines]{cancel}
\usepackage{fancyvrb}

\xdefinecolor{dianablue}{rgb}{0.18,0.24,0.31}
\xdefinecolor{darkblue}{rgb}{0.1,0.1,0.7}
\xdefinecolor{darkgreen}{rgb}{0,0.5,0}
\xdefinecolor{darkgrey}{rgb}{0.35,0.35,0.35}
\xdefinecolor{darkorange}{rgb}{0.8,0.5,0}
\xdefinecolor{darkorange2}{rgb}{1,0.5,0}
\xdefinecolor{darkred}{rgb}{0.7,0,0}
\xdefinecolor{darkpink}{rgb}{0.9,0.2,0.6}
\definecolor{darkgreen}{rgb}{0,0.6,0}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\title[2019-03-14-awkward-acat2019]{Nested data structures in array and SIMD frameworks}
\author{Jim Pivarski}
\institute{Princeton University -- DIANA-HEP, IRIS-HEP}
\date{March 14, 2019}

\usetikzlibrary{shapes.callouts}

\begin{document}

\logo{\pgfputat{\pgfxy(0.11, 7.4)}{\pgfbox[right,base]{\tikz{\filldraw[fill=dianablue, draw=none] (0 cm, 0 cm) rectangle (50 cm, 1 cm);}\mbox{\hspace{-8 cm}\includegraphics[height=1 cm]{princeton-logo-long.png}\includegraphics[height=1 cm]{diana-hep-logo-long.png}}}}}

\begin{frame}
  \titlepage
\end{frame}

\logo{\pgfputat{\pgfxy(0.11, 7.4)}{\pgfbox[right,base]{\tikz{\filldraw[fill=dianablue, draw=none] (0 cm, 0 cm) rectangle (50 cm, 1 cm);}\mbox{\hspace{-8 cm}\includegraphics[height=1 cm]{princeton-logo.png}\includegraphics[height=1 cm]{diana-hep-logo.png}}}}}

% Uncomment these lines for an automatically generated outline.
%\begin{frame}{Outline}
%  \tableofcontents
%\end{frame}

% START START START START START START START START START START START START START

%% \begin{frame}[fragile]{Nested, variable-sized data structures are crucial in HEP}
%% \vspace{0.25 cm}
%% \begin{columns}
%% \column{0.5\linewidth}
%% \includegraphics[width=\linewidth]{muons-as-objects.png}

%% \column{0.5\linewidth}
%% \includegraphics[width=\linewidth]{muons-as-a-table.png}
%% \end{columns}

%% \begin{uncoverenv}<2>
%% \vspace{0.25 cm}
%% Analysis datasets are big lists of variable-length lists of structs/objects/records.

%% \vspace{0.25 cm}
%% \scriptsize
%% \begin{Verbatim}[commandchars=\\\{\}]
%% [[Muon(\textcolor{darkgreen}{31.1}, \textcolor{darkorange}{-0.481}, \textcolor{blue}{0.882}), Muon(\textcolor{darkgreen}{9.76}, \textcolor{darkorange}{-0.124}, \textcolor{blue}{0.924}), Muon(\textcolor{darkgreen}{8.18}, \textcolor{darkorange}{-0.119}, \textcolor{blue}{0.923})],
%%  [Muon(\textcolor{darkgreen}{5.27}, \textcolor{darkorange}{1.246}, \textcolor{blue}{-0.991})],
%%  [Muon(\textcolor{darkgreen}{4.72}, \textcolor{darkorange}{-0.207}, \textcolor{blue}{0.953})],
%%  [Muon(\textcolor{darkgreen}{8.59}, \textcolor{darkorange}{-1.754}, \textcolor{blue}{-0.264}), Muon(\textcolor{darkgreen}{8.714}, \textcolor{darkorange}{0.185}, \textcolor{blue}{0.629})],
%%  ...
%% \end{Verbatim}
%% \end{uncoverenv}
%% \end{frame}

%% \begin{frame}[fragile]{Columnar representation}
%% \vspace{0.5 cm}

%% But they don't have to be ``structs,'' pointers to contiguous $p_T$, $\eta$, $\phi$ triples.

%% \scriptsize
%% \begin{Verbatim}[commandchars=\\\{\}]
%% [[Muon(\textcolor{darkgreen}{31.1}, \textcolor{darkorange}{-0.481}, \textcolor{blue}{0.882}), Muon(\textcolor{darkgreen}{9.76}, \textcolor{darkorange}{-0.124}, \textcolor{blue}{0.924}), Muon(\textcolor{darkgreen}{8.18}, \textcolor{darkorange}{-0.119}, \textcolor{blue}{0.923})],
%%  [Muon(\textcolor{darkgreen}{5.27}, \textcolor{darkorange}{1.246}, \textcolor{blue}{-0.991})],
%%  [Muon(\textcolor{darkgreen}{4.72}, \textcolor{darkorange}{-0.207}, \textcolor{blue}{0.953})],
%%  [Muon(\textcolor{darkgreen}{8.59}, \textcolor{darkorange}{-1.754}, \textcolor{blue}{-0.264}), Muon(\textcolor{darkgreen}{8.714}, \textcolor{darkorange}{0.185}, \textcolor{blue}{0.629})],
%%  ...
%% \end{Verbatim}
%% \normalsize

%% \vspace{0.5 cm}
%% They can be contiguous by field with \only<1>{\textcolor{red}{offsets}}\only<2,3,4>{offsets} or \only<2>{\textcolor{red}{starts/stops}}\only<1,3,4>{starts/stops} or \only<3>{\textcolor{red}{counts}}\only<1,2,4>{counts} or \only<4>{\textcolor{red}{parents}}\only<1,2,3>{parents} arrays.

%% \vspace{0.25 cm}
%% \begin{tabular}{r l}
%% \only<1>{\small \textcolor{red}{offsets} & \textcolor{red}{\tt\scriptsize \ \ \ \ \ 0,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 3,\ \ \ \ \ \ 4,\ \ \ \ \ \ 5,\ \ \ \ \ \ \ 7} \\}
%% \only<3>{\small \textcolor{red}{counts}  & \textcolor{red}{\tt\scriptsize \ \ \ \ \ 3,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1,\ \ \ \ \ \ 1,\ \ \ \ \ \ 2\ \ \ \ \ \ \ \ \ } \\}
%% \only<4>{\small \textcolor{red}{parents} & \textcolor{red}{\tt\scriptsize \ \ \ \ \ 0,\ \ \ \ \ \ 0,\ \ \ \ \ \ 0,\ \ \ \ \ \ 1,\ \ \ \ \ \ 2,\ \ \ \ \ \ 3,\ \ \ \ \ 3} \\}
%% \only<2>{\small \textcolor{red}{starts}  & \textcolor{red}{\tt\scriptsize \ \ \ \ \ 0,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 3,\ \ \ \ \ \ 4,\ \ \ \ \ \ 5\ \ \ \ \ \ \ \ \ } \\}
%% \uncover<2>{\small \textcolor{red}{stops}   & \textcolor{red}{\tt\scriptsize \ \ \ \ \ 3,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 4,\ \ \ \ \ \ 5,\ \ \ \ \ \ 7\ \ \ \ \ \ \ \ \ } \\}
%% \small $p_T$ & \textcolor{darkgreen}{\tt\scriptsize \ \ 31.1,\ \ \ 9.76,\ \ \ 8.18,\ \ \ 5.27,\ \ \ 4.72,\ \ \ 8.59, 8.714} \\
%% \small phi &  \textcolor{darkorange}{\tt\scriptsize -0.481,\ -0.123,\ -0.119,\ \ 1.246,\ -0.207,\ -1.754,\ 0.185} \\
%% \small eta &        \textcolor{blue}{\tt\scriptsize \ 0.882,\ \ 0.924,\ \ 0.923,\ -0.991,\ \ 0.953,\ -0.264,\ 0.629} \\
%% \end{tabular}
%% \end{frame}

%% \begin{frame}[fragile]{This allows for efficient ways of {\it manipulating} data}
%% \vspace{0.25 cm}

%% ``Remove the first muon from each event.'' \uncover<2->{\textcolor{red}{$\longrightarrow$ rewrite all inner lists.}}

%% \scriptsize
%% \begin{onlyenv}<1>
%% \begin{Verbatim}[commandchars=\\\{\}]
%% [[Muon(\textcolor{darkgreen}{31.1}, \textcolor{darkorange}{-0.481}, \textcolor{blue}{0.882}), Muon(\textcolor{darkgreen}{9.76}, \textcolor{darkorange}{-0.124}, \textcolor{blue}{0.924}), Muon(\textcolor{darkgreen}{8.18}, \textcolor{darkorange}{-0.119}, \textcolor{blue}{0.923})],
%%  [Muon(\textcolor{darkgreen}{5.27}, \textcolor{darkorange}{1.246}, \textcolor{blue}{-0.991})],
%%  [Muon(\textcolor{darkgreen}{4.72}, \textcolor{darkorange}{-0.207}, \textcolor{blue}{0.953})],
%%  [Muon(\textcolor{darkgreen}{8.59}, \textcolor{darkorange}{-1.754}, \textcolor{blue}{-0.264}), Muon(\textcolor{darkgreen}{8.714}, \textcolor{darkorange}{0.185}, \textcolor{blue}{0.629})],
%%  ...
%% \end{Verbatim}
%% \end{onlyenv}\begin{onlyenv}<2->
%% \begin{Verbatim}[commandchars=\\\{\}]
%% [[     \textcolor{darkgreen}{    }  \textcolor{darkorange}{      }  \textcolor{blue}{     }   Muon(\textcolor{darkgreen}{9.76}, \textcolor{darkorange}{-0.124}, \textcolor{blue}{0.924}), Muon(\textcolor{darkgreen}{8.18}, \textcolor{darkorange}{-0.119}, \textcolor{blue}{0.923})],
%%  [     \textcolor{darkgreen}{    }  \textcolor{darkorange}{     }  \textcolor{blue}{      } ],
%%  [     \textcolor{darkgreen}{    }  \textcolor{darkorange}{      }  \textcolor{blue}{     } ],
%%  [     \textcolor{darkgreen}{    }  \textcolor{darkorange}{      }  \textcolor{blue}{      }   Muon(\textcolor{darkgreen}{8.714}, \textcolor{darkorange}{0.185}, \textcolor{blue}{0.629})],
%%  ...
%% \end{Verbatim}
%% \end{onlyenv}
%% \normalsize

%% \vspace{0.5 cm}
%% ``Remove the first muon from each event.'' \uncover<2->{\textcolor{red}{$\longrightarrow$ increase all starts by 1.}}

%% \vspace{0.25 cm}
%% \begin{onlyenv}<1>
%% \begin{tabular}{r l}
%% \small starts  &                    {\tt\scriptsize \ \ \ \ \ 0,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 3,\ \ \ \ \ \ 4,\ \ \ \ \ \ 5\ \ \ \ \ \ \ \ \ } \\
%% \small stops   &                    {\tt\scriptsize \ \ \ \ \ 3,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 4,\ \ \ \ \ \ 5,\ \ \ \ \ \ 7\ \ \ \ \ \ \ \ \ } \\
%% \small $p_T$ & \textcolor{darkgreen}{\tt\scriptsize \ \ 31.1,\ \ \ 9.76,\ \ \ 8.18,\ \ \ 5.27,\ \ \ 4.72,\ \ \ 8.59, 8.714} \\
%% \small phi &  \textcolor{darkorange}{\tt\scriptsize -0.481,\ -0.123,\ -0.119,\ \ 1.246,\ -0.207,\ -1.754,\ 0.185} \\
%% \small eta &        \textcolor{blue}{\tt\scriptsize \ 0.882,\ \ 0.924,\ \ 0.923,\ -0.991,\ \ 0.953,\ -0.264,\ 0.629} \\
%% \end{tabular}
%% \end{onlyenv}\begin{onlyenv}<2->
%% \begin{tabular}{r l}
%% \small starts  &     \textcolor{red}{\tt\scriptsize \ \ \ \ \ 1,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 4,\ \ \ \ \ \ 5,\ \ \ \ \ \ 6\ \ \ \ \ \ \ \ \ } \\
%% \small stops   &                    {\tt\scriptsize \ \ \ \ \ 3,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 4,\ \ \ \ \ \ 5,\ \ \ \ \ \ 7\ \ \ \ \ \ \ \ \ } \\
%% \small $p_T$ & \textcolor{darkgreen}{\tt\scriptsize \ \ 31.1,\ \ \ 9.76,\ \ \ 8.18,\ \ \ 5.27,\ \ \ 4.72,\ \ \ 8.59, 8.714} \\
%% \small phi &  \textcolor{darkorange}{\tt\scriptsize -0.481,\ -0.123,\ -0.119,\ \ 1.246,\ -0.207,\ -1.754,\ 0.185} \\
%% \small eta &        \textcolor{blue}{\tt\scriptsize \ 0.882,\ \ 0.924,\ \ 0.923,\ -0.991,\ \ 0.953,\ -0.264,\ 0.629} \\
%% \end{tabular}\end{onlyenv}

%% \vspace{0.5 cm}
%% \uncover<3>{We didn't need to touch any contents (read them from disk, decompress them\ldots).}
%% \end{frame}

%% \begin{frame}{Library for manipulating non-standard array types}
%% \vspace{0.5 cm}
%% \begin{columns}
%% \column{0.45\linewidth}
%% \includegraphics[width=\linewidth]{awkward-logo.pdf}

%% \vspace{0.25 cm}
%% \hfill \scriptsize \textcolor{darkblue}{\url{github.com/scikit-hep/awkward-array}}

%% \column{0.55\linewidth}
%% \vspace{0.5 cm}
%% \vspace{2\baselineskip}
%% \begin{itemize}
%% \item variable-length subarrays
%% \item struct-of-arrays looking like array-of-structs
%% \item nullable types
%% \item heterogeneous types (tagged unions)
%% \item cross-references or even cyclic references
%% \item sparse, non-contiguous, lazy
%% \end{itemize}

%% \vspace{0.5 cm}
%% \uncover<2>{Any awkward array can be placed within any other awkward array.}
%% \end{columns}
%% \end{frame}

%% \begin{frame}[fragile]{Not lacking for data types}
%% \vspace{0.5 cm}
%% Nullable, heterogeneous, multiple levels of depth, nested records\ldots

%% \small
%% \begin{minted}{python}
%% >>> import awkward
%% >>> array = awkward.fromiter(
%% ...     [[1.1, 2.2, None, 3.3, None],
%% ...      [4.4, [5.5]],
%% ...      [{"x": 6, "y": {"z": 7}}, None, {"x": 8, "y": {"z": 9}}]])
%% \end{minted}

%% \begin{uncoverenv}<2->
%% \begin{minted}{python}
%% >>> print(array)            # internally, these are all arrays
%% [[1.1 2.2 None 3.3 None] [4.4 [5.5]] [<Row 0> None <Row 1>]]
%% \end{minted}
%% \end{uncoverenv}

%% \begin{uncoverenv}<3->
%% \begin{minted}{python}
%% >>> print(array[:, -2:])    # all of outer list, last two of inner
%% [[3.3 None] [4.4 [5.5]] [None <Row 1>]]
%% \end{minted}
%% \end{uncoverenv}

%% \begin{uncoverenv}<4->
%% \begin{minted}{python}
%% >>> (array + 100).tolist()  # element-wise function applied to arrays
%% [[101.1, 102.2, None, 103.3, None],
%%  [104.4, [105.5]],
%%  [{'x': 106, 'y': {'z': 107}}, None, {'x': 108, 'y': {'z': 109}}]]
%% \end{minted}
%% \end{uncoverenv}
%% \end{frame}

%% \begin{frame}{Columnar data structures minimize memory use and time}
%% \vspace{0.5 cm}
%% One operation, deriving $p_z$ of a variable number of $p_T$ and $\eta$ per event, using \textcolor{darkorange2}{awkward-array}, \textcolor{blue}{ROOT}, \textcolor{darkpink}{pure Python}, and \textcolor{darkgreen}{root\_numpy}.

%% \vspace{0.2 cm}
%% \begin{center}
%% \includegraphics[width=0.9\linewidth]{logscales.pdf}
%% \end{center}
%% \end{frame}

%% \begin{frame}{Real life}
%% \vspace{0.5 cm}
%% \LARGE
%% \begin{center}
%% a single operation $\ne$ a physics analysis
%% \end{center}
%% \end{frame}

%% \begin{frame}{Performing complete analyses with columnar tools}
%% \vspace{0.5 cm}
%% \begin{columns}
%% \column{0.2\linewidth}
%% \includegraphics[width=\linewidth]{coffea-logo.png}

%% \column{0.8\linewidth}
%% \hspace{-0.2 cm}\Huge Coffea

%% \vspace{0.25 cm}
%% \large {\bf C}olumnar {\bf O}bject {\bf F}ramework {\bf F}or {\bf E}fficient {\bf A}nalysis

%% \vspace{0.25 cm}
%% \normalsize Matteo~Cremonesi, Lindsey~Gray, Oliver~Gutsche, Allison~Hall, Bo~Jayatilaka, Igor~Mandrichenko, Kevin~Pedro, Nick~Smith~[FNAL], and~me~[Princeton] \hfill \textcolor{blue}{\url{github.com/CoffeaTeam}}
%% \end{columns}

%% \begin{center}
%% \begin{minipage}{0.65\linewidth}
%% \large Performing two complete CMS analyses:
%% \begin{itemize}
%% \item Dark Higgs search
%% \item Boosted SM $H \to b\bar{b}$
%% \end{itemize}
%% \end{minipage}
%% \end{center}

%% \vspace{0.25 cm}
%% Also developing {\tt fnal-column-analysis-tools}, a HEP layer on awkward-array,
%% and a distributed query processing system with Ben Galewsky, Mark Neubauer [Illinois], and Andrew Melo [Vanderbilt].
%% \end{frame}

%% \begin{frame}{First finished analysis: $Z$ peak}
%% \vspace{0.5 cm}
%% $Z$ peak is the ``hello world'' of analysis frameworks.

%% \vspace{0.25 cm}
%% This implementation is realistic: run/lumi mask, pile-up correction, ID scale factors, and $ee$/$\mu\mu$/$e\mu$ channels. 350~lines in a Jupyter notebook.

%% \vspace{0.5 cm}
%% \textcolor{blue}{\small \url{github.com/nsmith-/coffea/blob/master/notebooks/zpeak.ipynb}}

%% \vspace{0.5 cm}
%% \begin{columns}[b]
%% \column{0.4\linewidth}
%% \large
%% \begin{description}
%% \item[columnar analysis:] \hfill \mbox{\hspace{-1 cm}8~$\mu$s/event/thread (125~kHz)}
%% \item[ROOT C++:] \hfill \mbox{\hspace{-1 cm}5.3~$\mu$s/event/thread (190~kHz)}
%% \end{description}

%% \vspace{0.25 cm}
%% Columnar analysis is about 50\% slower than its C++ equivalent.

%% \column{0.4\linewidth}
%% \includegraphics[width=\linewidth]{zpeak-performance-breakdown.png}
%% \end{columns}
%% \end{frame}

%% \begin{frame}[fragile]{Second near-complete analysis}
%% \vspace{0.5 cm}
%% \begin{columns}[t]
%% \column{0.4\linewidth}
%% \textcolor{darkblue}{Prototype of $H \to b\bar{b}$ has}
%% \begin{itemize}
%% \item recursive gen parent-finding
%% \item gen-reco matching
%% \item binned corrections
%% \item parametric corrections
%% \item systematics
%% \end{itemize}

%% \large
%% \vspace{0.25 cm}
%% 30~$\mu$s/event/thread (30~kHz)

%% \column{0.6\linewidth}
%% \begin{uncoverenv}<2->
%% Example of combinatorics: gen-reco matching

%% \small
%% \begin{minted}{python}
%% # make an array of all gen-reco pairs
%% pairing = gen.cross(reco, nested=True)

%% # delta R between gen (i0) and reco (i1)
%% metric = pairing.i0.delta_r(pairing.i1)

%% # the smallest delta R is best (indexes)
%% best = metric.argmin()

%% # but keep only delta R < 0.5 (mask)
%% passes_cut = (metric[best] < 0.5)

%% # now apply indexes and mask to select
%% selected_pair = pairing[best][passes_cut]
%% genrecos = selected_pair.flatten(axis=1)
%% \end{minted}
%% \end{uncoverenv}
%% \end{columns}
%% \end{frame}

\begin{frame}{}

\end{frame}




\end{document}
